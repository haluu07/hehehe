
name: CI/CD Deploy to EC2 (Apache)

# Trigger the workflow on push to the main branch
on:
  push:
    branches:
      - main  # Thay đổi thành nhánh bạn muốn trigger, ví dụ: 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest  # Chạy job trên Ubuntu

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4  # Lấy mã nguồn từ repo

      # 2. Kiểm tra xem Secrets đã đủ chưa
      - name: Validate required secrets
        run: |
          [ -z "${{ secrets.EC2_HOST }}" ] && echo "EC2_HOST is missing" && exit 1 || true
          [ -z "${{ secrets.EC2_USER }}" ] && echo "EC2_USER is missing" && exit 1 || true
          [ -z "${{ secrets.SSH_KEY }}" ] && echo "SSH_KEY is missing" && exit 1 || true
          echo "All required secrets present."

      # 3. Setup SSH key
      - name: Setup SSH key
        run: |
          echo "${{ secrets.SSH_KEY }}" > docker.pem
          chmod 600 docker.pem  # Đảm bảo quyền file key

      # 4. Pre-flight check: SSH vào EC2 để kiểm tra kết nối
      - name: Pre-flight SSH check
        run: |
          ssh -o StrictHostKeyChecking=no -i docker.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSH OK'; mkdir -p /var/www/html"

      # 5. Rsync code lên EC2, exclude thư mục .git và .github
      - name: Rsync to EC2 (exclude git & secrets)
        run: |
          rsync -avz -e "ssh -o StrictHostKeyChecking=no -i docker.pem" --delete \
            --exclude ".git/" --exclude ".github/" --exclude "docker.pem" \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/html/

      # 6. Restart Apache trên EC2
      - name: Restart Apache
        run: |
          ssh -o StrictHostKeyChecking=no -i docker.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "sudo systemctl restart httpd || sudo systemctl restart apache2"
